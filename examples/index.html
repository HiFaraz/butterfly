<html>

<head>
</head>

<body>
    <div id="app"></div>
    <div id="preview"></div>
    <script src="https://unpkg.com/marked@0.3.6"></script>
    <script src="../../proxyfull/src/proxyfull.js"></script>
    <script src="../src/rudy.js"></script>
    <script>

        'use strict';

        // let's go! all you have to do is send an object to rudy.
        // hang on to the returned object btw, you can do stuff with it later
        var person = rudy(

            // the component behaviour is fed as object properties
            {

                // specify the tag id where you want to render your component
                target: '#app',

                // enter your initial data
                data : {
                    name: 'John',
                    age: 30,
                    address: {
                        country: 'Canada'
                    },
                    actor: true,

                    // your data can be functions! this function is called everytime
                    // new data is bound to the view, including the initialization.
                    // all values passed to `this` are read-only and changing them 
                    // will not affect the view nor model

                    // you can calculate data on every model/view update!
                    ageFn: function() {
                        
                        // you can access the rest of the model in here!
                        // the `this` variable will give you a locally scoped copy of the model
                        // console.log('I\'m calling you from *inside* the function', this.age);

                        // remember, you only have a local copy of the model
                        // you can alter it, but it will not have an affect outside of this function
                        // and it will not update the view
                        this.age = 1;

                        // return a value to pass it to the model (should be: 2)
                        return this.age * 2;
                    }
                },

                // create some watchers! get notified by input events and model updates
                // to enable two-way binding on all variables, set `watchers: true`
                // instead of passing it an object
                watchers: {

                    // setting to `true` tells Rudy to enable two-way data-binding on all form elements
                    actor: true,

                    // this function does not return anything to the form element. Instead it does another
                    // operation entirely. It reflects a Markdown preview in another <div> tag
                    address: {
                        country: function(value, element) {
                            document.getElementById('preview').innerHTML = marked(value, { sanitize: true });

                            // instead of omitting the return statement, you can also explicitly return a falsy value
                            // for example: `return false;` or `return null;` - these will not cause the form element
                            // to update
                            
                        }
                    },

                    age: true,

                    // watcher functions run BEFORE any data calculations or bindings happen (interception)
                    // you can use this to intercept asynchronous requests
                    email: function(value, element) {
                        
                        // whatever you return from here will be set in the model and view 
                        return value.toLowerCase();
                    },

                    // let's force all name to be UPPERCASE 
                    name: function(value, element) {
                        return value.toUpperCase();
                    }
                },

                // this function is called once before the first render
                create: function() {
                    var vm = this;

                    vm.name = 'James';
                    vm.age = 25;
                    vm.actor = false;
                    
                    // asynchronous binding updates allowed! we define this function way down below
                    getResource('https://jsonplaceholder.typicode.com/comments/1')
                        .then(function(body) {

                            // notice that email wasn't originally a property of the data object
                            vm.email = body.email;
                        });
                },
                template:
                    `
                    <table style="border: 1px solid black">
                        <thead>
                            <tr>
                                <td>Description</td>
                                <td>View(s)</td>
                                <td>Comments</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Unlinked text input:</td>
                                <td><input type="text"></td>
                                <td>not linked to any component data at all</td>
                            </tr>
                    `

                    +

                    // you can enable two-way data binding on a single form element ONLY by adding a `watched` attribute
                    // you can output the model value as text by using moustache/double-brace templates: e.g. {{ variable_name }}
                    `
                            <tr>
                                <td>Name:</td>
                                <td>
                                    <input type="text" name="name" watched><br>
                                    {{ name }}
                                </td>
                                <td>watched by \`watched\` attribute</td>
                            </tr>
                            <tr>
                                <td>Age:</td>
                                <td>
                                    <input type="range" name="age"><br>
                                    {{ age }}
                                </td>
                                <td>watched by setting watcher to true</td>
                            </tr>
                            <tr>
                                <td>Computed age:</td>
                                <td>
                                    <input type="text" name="ageFn"><br>
                                    {{ ageFn }}
                                </td>
                                <td>not watched, no two-way data binding</td>
                            </tr>
                    `

                    +

                    // you can disable two-way data binding on a single form element ONLY by adding a `unwatched` attribute,
                    // in case you allowed it globally or even by the `watched` attribute
                    `
                            <tr>
                                <td> Is actor: </td>
                                <td>
                                    <input type="checkbox" name="actor" unwatched><br>
                                    {{ actor }}
                                </td>
                                <td> watched globally by setting watcher to true, but disabled on this input element by \`unwatched\` attribute </td>
                            </tr>
                            <tr>
                                <td> Country description: </td>
                                <td>
                                    <textarea name="address.country"></textarea><br>
                                    {{ address.country }}
                                </td>
                                <td> watched by setting watcher to true, also creates markdown preview in \`#preview\` </td>
                            </tr>
                            <tr>
                                <td> Email: </td>
                                <td>
                                    <input type="text" name="email"><br>
                                    {{  email  }}
                                </td>
                                <td> watched by watcher function </td>
                            </tr>
                            <tr>
                                <td> Gender: </td>
                                <td>
                                    <select name="gender" watched>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select><br>
                                    {{ gender }}
                                </td>
                                <td> watched by \`watched\` attribute </td>
                            </tr>
                            <tr>
                                <td> Age & Gender: </td>
                                <td> {{ age }} | {{ gender }} </td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    `
                
                // you can also load a template from a file! the order of precedence is:
                // templateURL > template > whatever is already in the target element
                // templateURL: '/partials/app.html'
            }
        );

        // you don't need to be inside your component object to update the data. let's change an existing value
        person.data.name = 'Micheal';

        // go ahead, overwrite the whole data object
        person.data = {
            name: 'Maria',
            age: 55,
            ageFn: function() {
                return this.age / 2;
            }
        };

        // let's add back some values we wiped away
        person.data.address = {country: 'Colombia'};
        person.data.address.country = '# Mexico\n* A land of wonder';
        person.data.actor = true;

        // and one more brand new variable
        person.data.gender = 'female';

        // this is a utility function to make an AJAX request. it's not part of Rudy. we'll use it down below to bind the view to a server response
        function getResource(url, callback) {

            return new Promise(function(resolve,reject) {

                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.onload = function () {
                    if (request.readyState != 4 || request.status != 200) reject();
                    else resolve(JSON.parse(request.responseText));
                }; 
                try {
                    request.send();
                }
                catch (error) {
                    reject(error);
                }

            });

        }
        
    </script>
</body>

</html>